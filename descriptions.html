<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <script type="text/javascript" src="mqttws31.js"></script>
    <script type="text/javascript" src="jquery-2.1.4.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="bootstrap-3.3.6-dist/css/bootstrap.min.css">
    <script src="bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
    <script src="config.js" type="text/javascript"></script>
    <!--<script src="EventSubscription.js" type="text/javascript"></script>-->
    <script src="EventSubscription-compiled.js" type="text/javascript"></script>

</head>
<body>

<nav class="navbar navbar-default">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">MQTT Schema</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li><a href="index.html">Topic Tree<span class="sr-only">(current)</span></a></li>
                <li class="active"><a href="descriptions.html">Description Browser</a></li>
            </ul>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
</nav>

<div id="list" class="row">
    <div class="col-md-12">
        Schemas:
        <ul></ul>
    </div>
</div>
<div class="row">
    <div id="detail" class="col-md-6">
        <textarea id="txt" readonly rows="40" cols="100"></textarea>
    </div>
    <div class="col-md-6">

        <div id="doc">
            <div id="chart_div" style="width: 400px; height: 120px;"></div>


        </div>
    </div>
</div>


<script type="text/javascript">

    var schemas = {};
    var subscriptions = {};

    var client = new Paho.MQTT.Client(host, port, '/', 'descBrowser');
    client.onMessageArrived = onMessage;
    client.onconnectionlost = onDisconnect;
    function onConnect() {
        client.subscribe('+/+/+/+/schema/#', onMessage);
        console.log("MQTT connected");
    }

    client.connect({onSuccess: onConnect});

    function onMessage(message) {
        console.log(message.destinationName + " - " + message.payloadString);
        var topics = message.destinationName.split("/");
        var deviceType = topics[3];
        schemas[deviceType] = message.payloadString;

        // TODO: Avoid duplicate <li>s
        $('#list ul').append(
                $('<li>').append(
                        $('<a>').attr({href: '#', id: deviceType}).append(deviceType)
                                .click(function (e) {

                                    console.log(this.id);
                                    $('#txt').val(schemas[this.id]);

                                    var json = JSON.parse(schemas[this.id]);

                                    $('#doc').text('');

                                    //console.log(json.commandDescription.commands);

                                    // TODO: meta infos (version , etc).
                                    //$('#commands').text(json.id).append(' - ').append(json.version);

                                    $('#doc').append('<h2>State</h2>');
                                    json.stateDescription.states.forEach(function (state) {
                                        $('#doc').append(renderState(state));
                                    });

                                    $('#doc').append('<h2>Events</h2>');
                                    json.eventDescription.events.forEach(function (event) {
                                        $('#doc').append(renderEvent(event)).append('<br>');
                                    });

                                    $('#doc').append('<h2>Commands</h2>');
                                    json.commandDescription.commands.forEach(function (cmd) {
                                        $('#doc').append(renderCmd(cmd)).append('<br>');
                                    });
                                    evtHandler();
                                })
                ));

        function renderState(state) {
            var res = '<strong>' + state.topic + '</strong> <br>';
            res += state.desc + '<br>';
            res += renderRange(state.range);
            return res + '<br>';
        }


        function renderCmd(cmd) {
            //console.log(cmd);
            var res = '<strong>' + cmd.name + '</strong> <br>';

            res += 'Linked state: ' + cmd.linkedState + '<br>';

            $.each(cmd.params, function (key, value) {
                //console.log(value);
                res += key + '<br>';
                //console.log(value);
                if (value.hasOwnProperty('min')) {
                    res += renderRange(value);
                } else {
                    res += renderPresets(value);
                }
            });

            return res + '<br>';
        }

        function renderEvent(event) {
            //console.log('Event: ' + event.name);
            var eventName = event.name;
            var res = '<strong>' + eventName + '</strong> <br>';
            res += event.desc + '<br>';
            res += renderRange(event.range);

            res += '<form class="form-inline">';
            res += '    <div class="form-group">';
            res += '        <button data-id="' + eventName + '" class="btn btn-default evt" type="button">Subscribe</button>';
            res += '        <input id="' + eventName + '"type="text" class="form-control">';
            res += '    </div>';
            res += '</form>';

            return res;
        }
    }

    function renderPresets(presets) {
        console.log(presets);
        var res = '';
        $.each(presets, function (index, value) {
            res += value + ' ';
        });

        return res + '<br>';
    }

    function renderRange(range) {

        if (range == null) {
            return 'No Range <br>';
        }

        var res = 'Type: ' + range.type + '<br>';
        res += 'Min: ' + range.min + '<br>';
        res += 'Max: ' + range.max + '<br>';
        return res;
    }

    function onDisconnect(reason) {
        console.log("disconnected - " + reason);
        alert("disconnected - " + reason);
    }

    function evtHandler() {
        $('.evt').click(function () {
            //alert( "Handler for .click() called." );
            //subscribe();
            var eventName = $(this).data('id');

            var sub;
            if (!(eventName in subscriptions)) {
                sub = new Subscription();
                subscriptions[eventName] = sub;
            } else {
                sub = subscriptions[eventName];
            }

            // TODO: topic Ã¼bergeben


            console.log($(this).text());
            $(this).toggleClass("active");
            if ($(this).text() === 'Subscribe') {
                sub.subscribe(eventName);
                $(this).text('Unsubscribe');
            } else {
                $(this).text('Subscribe');
                sub.unsubscribe(eventName);
            }


        });
    }
</script>
</body>
</html>
